# first review prompt
# this prompt is used for the first (comprehensive) review pass in phase 2
# launches 5 parallel agents for thorough code review
#
# available variables:
#   {{PLAN_FILE}} - path to the plan file being executed
#   {{PROGRESS_FILE}} - path to the progress log (task execution + previous reviews)
#   {{GOAL}} - human-readable goal description
#   {{DEFAULT_BRANCH}} - default branch name (main, master, trunk, etc.)
#   {{agent:name}} - expands to Task tool instructions for the named agent
#
# agents are defined in .ralphex/agents/ (local) or ~/.config/ralphex/agents/ (user)

Code review of: {{GOAL}}

Progress log: {{PROGRESS_FILE}} (contains task execution and previous review iterations)

## Step 1: Get Branch Context

Run both commands to understand what was done:
- `git log {{DEFAULT_BRANCH}}..HEAD --oneline` - see commit history (what was implemented)
- `git diff {{DEFAULT_BRANCH}}...HEAD` - see actual code changes

## Step 2: Launch ALL 5 Review Agents IN PARALLEL

Launch all agents using the Task tool with run_in_background=true (all in one response).
Then immediately call TaskOutput(task_id, block=true) for EACH agent to wait for its completion.
Collect ALL results before proceeding.

Agents to launch:
{{agent:quality}}
{{agent:implementation}}
{{agent:testing}}
{{agent:simplification}}
{{agent:documentation}}

Each agent prompt should include the diff and instruct: "Report problems only - no positive observations."

## Step 3: Collect, Verify, and Fix Findings

After agents complete:

### 3.1 Collect and Deduplicate
- Merge findings from all agents
- Same file:line + same issue → merge
- Cross-agent duplicates → merge, note both sources

### 3.2 Verify EVERY Finding (CRITICAL)
For EACH issue (template errors, config problems, broken references, docs, etc.):
1. Read actual code at file:line
2. Check full context (20-30 lines around)
3. Verify issue is real, not a false positive
4. Check for existing mitigations

Classify as:
- CONFIRMED: Real issue, fix it
- FALSE POSITIVE: Doesn't exist or already mitigated - discard

IMPORTANT: Pre-existing issues should also be fixed.
Do NOT reject issues just because they existed before this branch - fix them anyway.

### 3.3 Fix All Confirmed Issues
1. Fix all CONFIRMED issues (all types: template errors, config, content, docs, etc.)
2. Run `hugo` to verify fixes - build must complete without errors
3. Commit fixes: `git commit -m "fix: address code review findings"`

## Step 4: Signal Completion

SIGNAL LOGIC - READ CAREFULLY:

REVIEW_DONE means "this iteration found ZERO issues" - NOT "I finished fixing issues".

Path A - NO confirmed issues found:
- You reviewed the code and found nothing to fix
- Output: <<<RALPHEX:REVIEW_DONE>>>

Path B - Issues found AND fixed:
- You found issues, fixed them, and committed
- STOP HERE. Do NOT output any signal. Do NOT output REVIEW_DONE.
- The external loop will run another review iteration to verify your fixes.
- Your fixes might have introduced new issues - another iteration must check.

Path C - Issues found but cannot fix:
- Output: <<<RALPHEX:TASK_FAILED>>>

OUTPUT FORMAT: No markdown formatting (no **bold**, `code`, # headers). Plain text and - lists are fine.
